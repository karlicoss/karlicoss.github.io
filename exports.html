<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Icon made by Twitter -->
        <!-- https://twemoji.twitter.com/content/twemoji-twitter/en.html -->
        <link rel="icon" href="./robot-face.png">
        <link rel="apple-touch-icon" href="./robot-face.png">

        <meta name="generator" content="hakyll">
        <meta name="language" content="English">
        
        <meta name="keywords" content="infra dataliberation pkm">
        
        <!-- TODO concat with keywords tags; also need to make comma separated? -->

        <title>Building data liberation infrastructure | Mildly entertainingᵝ</title>

        <link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="./css/default.css?v=3" />
        <link rel="stylesheet" href="./css/links.css?v=4" />

        
    </head>
    <body>
        <header>
            <nav>
                <span class="nav-left">
                    <a class="fat" href="./">Home</a>
                    <!-- TODO eh, not sure if this symbol is good for that... -->
                    ·
                    <a class="fat" href="./ideas.html">Ideas</a>
                    ·
                    <a class="fat" href="./notes.html">Notes</a>
                    ·
                    <a class="fat" href="./tags.html">Tags</a>
                </span>
                <span class="nav-right">
                    <a class="fat" href="./feed.html">Feed</a>
                    ·
                    <a class="fat" href="./site.html">Site</a>
                    ·
                    <a class="fat" href="./me.html">Me</a>
                </span>
            </nav>
        </header>

        <main>
            

<!-- <link rel="stylesheet" href="/css/org.css" /> -->

<link rel="stylesheet" href="./css/htmlize.css" />
<link rel="stylesheet" href="./css/org-default.css" />

<link rel="stylesheet" href="./css/org-extra.css?v=3" />



<article>
    
    <div>THIS IS A DRAFT! It will appear on the main page once finished!</div>
    
    <section class="post-title">
    <h1>Building data liberation infrastructure</h1>
    <div class="summary">How to export and access your personal data with minimal effort</h2>
    </section>
    <!-- are sections appropriate for that? -->

    <section class="content">
    <p>
<b>Draft stage</b>: mostly ready in terms of what I want to say and structure, writing needs to be improved.
</p>
<p>
Our personal data is trapped, siloed and very hard to access for various reasons.
I wrote and vented a lot about in the <a href="sad-infra.html">previous post</a>.
</p>
<p>
People suggest a whole spectrum of possible solutions to these issues, starting from proposals on dismantling capitalism and ending with high tech vaporwavy stuff like <a href="https://en.wikipedia.org/wiki/Urbit">urbit</a>.
</p>
<p>
I, however, want my data <b>here and now</b>. I'm also fortunate to be a software engineer so I can bring this closer to reality by myself.
</p>
<p>
As a pragmatic intermediate solution, feasible with existing technology and infrastructure without reinventing everything from scratch, 
I suggested a <a href="sad-infra.html#data_mirror">'data mirror'</a>, an app that continuously syncs/mirrors user's personal data.
</p>
<p>
So, as I promised, this post will be somewhat more specific (some might say boring).
I will be presenting and elaborating on different technical decisions, patterns and tricks I figured out while developing data mirrors by myself.
In hindsight some things feel so obvious that they hardly deserve mention, but I hope that would be helpful anyway!
</p>
<p>
You can also read this as a kind of <b>tutorial</b> on liberating your data from any service.
</p>
<p>
I'm also extremely open to hear questions like "Why didn't you do Y instead of X?". 
It's quite possible that I'm slipping extra complexity somewhere and I would be very happy to eliminate it.
</p>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#design">1. Design principles</a></li>
<li><a href="#retrieve">2. Retrieving data</a>
<ul>
<li><a href="#org0000000">public API</a></li>
<li><a href="#org0000001">private API</a></li>
<li><a href="#export_scrape">scraping</a></li>
<li><a href="#export_manual">manual export (GDPR/takeout)</a></li>
<li><a href="#export_phone">phone apps</a></li>
<li><a href="#export_devices"><span class="todo TODO">TODO</span> devices?</a></li>
</ul>
</li>
<li><a href="#types">3. Types of exports</a>
<ul>
<li><a href="#full">full export</a></li>
<li><a href="#incremental">incremental export</a></li>
<li><a href="#synthetic">synthetic export</a></li>
</ul>
</li>
<li><a href="#export_layer">4. Export layer</a>
<ul>
<li><a href="#bindings">use existing bindings</a></li>
<li><a href="#org0000002">do not mess with raw data</a></li>
<li><a href="#org0000003">do not be too defensive</a></li>
<li><a href="#output_stdout">output to stdout</a></li>
<li><a href="#org0000004"><span class="timestamp-wrapper"><span class="timestamp">[2019-12-26 23:22]</span></span> allow reading credentials from a file</a></li>
</ul>
</li>
<li><a href="#org0000005">5. Data organization: how to keep it</a>
<ul>
<li><a href="#timestamps">naming and timestamping</a></li>
<li><a href="#backups">backups</a></li>
<li><a href="#sync">synchronizing</a></li>
<li><a href="#org0000006">disk space concerns</a></li>
</ul>
</li>
<li><a href="#arctee">6. arctee</a>
<ul>
<li><a href="#org0000007"><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-28 23:56]</span></span> I guess in 'DAL' mention that bwrapper is useful here too.</a></li>
</ul>
</li>
<li><a href="#org0000008">7. <span class="todo TODO">TODO</span> Running/scheduling exports etc?</a>
<ul>
<li><a href="#org0000009"><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-30 00:59]</span></span> going to overlap with data organization bit?</a></li>
<li><a href="#org000000a"><span class="todo TODO">TODO</span> suggest using fcron?   <span class="tag"><span class="exports">exports</span></span></a></li>
<li><a href="#org000000b"><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 22:26]</span></span> I feel a real lack of user-friendly job running software</a></li>
</ul>
</li>
<li><a href="#dal">8. Data access layer (DAL)</a>
<ul>
<li><a href="#org000000c"><span class="todo TODO">TODO</span> normalization? E.g. new field was added, basically schema change. That means old data needs to be adapted</a></li>
<li><a href="#org000000d"><span class="todo TODO">TODO</span> <span class="priority">[C]</span> would be nice to have main for models?   <span class="tag"><span class="dataliberation">dataliberation</span></span></a></li>
<li><a href="#org000000e"><span class="todo TODO">TODO</span> <span class="priority">[C]</span> do simple html dashboards for each exporter?   <span class="tag"><span class="dataliberation">dataliberation</span></span></a></li>
<li><a href="#org000000f"><span class="todo TODO">TODO</span> <span class="priority">[C]</span> take single path as argument? or maybe glob=true?   <span class="tag"><span class="dataliberation">dataliberation</span></span></a></li>
<li><a href="#org0000010"><span class="todo TODO">TODO</span> it's also an experiment in organizing code. demo etc, immediately visualize stuff with pandas   <span class="tag"><span class="exports">exports</span> <span class="blog">blog</span> <span class="dal">dal</span></span></a></li>
</ul>
</li>
<li><a href="#org0000011">9. Similar projects and efforts</a>
<ul>
<li><a href="#org0000012">perkeep</a></li>
<li><a href="#org0000013"><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2018-09-18 02:13]</span></span> Perkeep lets you permanently keep your stuff, for life. /r/selfhosted   <span class="tag"><span class="pkm">pkm</span></span></a></li>
<li><a href="#org0000014"><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-23 16:21]</span></span> Perkeep: personal storage system for life | Hacker News   <span class="tag"><span class="graspw">graspw</span> <span class="pkm">pkm</span></span></a></li>
<li><a href="#org0000015"><span class="todo TODO">TODO</span> <span class="priority">[C]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-22 16:19]</span></span> perkeep   <span class="tag"><span class="gr">gr</span></span></a></li>
<li><a href="#org0000016"><span class="todo TODO">TODO</span> <span class="priority">[A]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-15 21:31]</span></span> Digital Tools I Wish Existed | Hacker News   <span class="tag"><span class="perkeep">perkeep</span></span></a></li>
<li><a href="#org0000017"><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-23 16:19]</span></span> Perkeep – Open-source data modeling, storing, search, sharing and synchronizing | Hacker News   <span class="tag"><span class="graspw">graspw</span> <span class="pkm">pkm</span></span></a></li>
</ul>
</li>
<li><a href="#org0000018">10. --</a></li>
<li><a href="#org0000019">11. <span class="todo TODO">TODO</span> example of not keeping raw data: praw   <span class="tag"><span class="exports">exports</span> <span class="blog">blog</span> <span class="reddit">reddit</span></span></a></li>
<li><a href="#org000001a">12. <span class="todo TODO">TODO</span> arctee motivation of treating all errors as api flickering/network   <span class="tag"><span class="blog">blog</span> <span class="exports">exports</span></span></a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org000001b">
<h2 id="design"><a class="headerlink" href="#design">¶</a><span class="section-number-2">1</span> Design principles</h2>
<div class="outline-text-2" id="text-design">
<p>
So just as reminder, what is the goal of data mirror?
Having personal data <b>continuously/periodically synchronized</b> to the file system; and having <b>programmatic access</b> to it.
</p>
<p>
That may be not that hard to achieve for one particular data source, but when you want to use ten or more (TODO link to what I export),
each having its own quirks it becomes quite painful to write and support.
So there is TODO are? lots of incentive to make is, simple, generic, reliable and flexible at the same time, which isn't an easy goal.
</p>
<div><span class="before-aside">
Cornerstone of my design is modularity and separation of concerns. Most of my pipelines for data liberation consist of the following layers:

</span><aside class="sidenote">please don't be terrified of the word 'layer', typically these are just single scripts</aside></div>
<ul class="org-ul">
<li><p>
<a class="link-down" href="#export_layer">export layer</a>: knows how to get your data
</p>
<p>
The purpose of export layer is to reliably fetch and serialize raw data on your disk.
</p>
<p>
Export script deals with dirty business of authorization, pagination, being tolerant to network errors, etc.
</p>
<p>
Example: export layer for my <a href="https://github.com/karlicoss/endoexport/blob/e322b44ca1e6e5a779b4e7ea49564ba60d425bfe/export.py#L10-L15">Endomondo data</a> 
is fetching workouts data from the API (using existing library bindings) and prints the json out. That's all it does.
</p>
<p>
In theory, this layer is the only essential one; merely having raw json data on the filesystem enables you to use numerous tools to explore and analyze your data. However, long term you'll find yourself doing same manipulations all over again, and that's why we also need:
</p></li>
<li><p>
<a class="link-down" href="#dal">data access layer (DAL)</a>: knows how to read your data
</p>
<p>
For brevity, I'll refer to it as <b>DAL</b> (Data Abstraction/Access Layer).
</p>
<p>
Purpose of DAL is simply deserializing whatever export script dumped and providing minimalistic data bindings.
It shouldn't worry about tokens, network errors, etc., once you have your data on the disk DAL should be able to handle it even when you're offline.
</p>
<p>
It's not meant to be too high level though TODO mypkg
</p>
<p>
Example: <a href="https://github.com/karlicoss/fbmessengerexport/blob/a8f65a259dfa36ab6d175461994356947ded142a/model.py#L27-L47">DAL for Facebook Messenger</a> knows how to read messages from the database, access certain fields (e.g. message body) and handle obscure details like converting timestamps to <samp class="inline">datetime</samp> object. It's <b>not</b> trying to get messages from Facebook, which makes it way faster and more reliable to interact with data.
</p></li>
</ul>
<p>
It's clearly reasonable to keep export code and DAL code close as you don't want them to go out of sync and that's what I'm doing (TODO).
</p>
<p>
There is also what you could call the third layer which consists of downstream consumers of abstract (i.e. non-raw) data from DAL.
These are the actually interesting bits of TODO that contain visualizations, interactions across different data sources etc. 
I mention some of them <a href="sad-infra.html#mypkg">here</a>.
</p>
<p>
Now I'm going to elaborate on implementing export layer.
</p>
</div>
</div>
<div class="outline-2" id="outline-container-org0000020">
<h2 id="retrieve"><a class="headerlink" href="#retrieve">¶</a><span class="section-number-2">2</span> Retrieving data</h2>
<div class="outline-text-2" id="text-retrieve">
<p>
First step in exporting and liberating your data is to figure out how are you actually supposed to fetch it?
</p>
<p>
This addresses the authorization problem. TODO?
TODO maybe just mention the problems we're solving in the intro?
</p>
<p>
TODO Ordered from best to worst.
</p>
<p>
I'll mostly refer to Python libraries since that's what I'm familiar with, but I'm quite sure there are analogues in other languages.
</p>
<p>
Also remember, this is just to fetch data! You can serialize your export as any common format, and use any other programming language you like to access it.
That's the beauty of decoupling.
</p>
</div>
<div class="outline-3" id="outline-container-org0000000">
<h3 id="org0000000"><a class="headerlink" href="#org0000000">¶</a>public API</h3>
<div class="outline-text-3" id="text-org0000000">
<p>
You register your app, authorize it, get a token, and you are free to call various endpoints and fetch whatever you want.   
</p>
<p>
I won't really elaborate on it TODO, if you're reading this you probably have some idea how to use it.
Otherwise, I'm sure there are tutorials out there that would help you.
</p>
<p>
(if anyone knows decent ones, please let me know, I'll add links!)
</p>
<p>
Examples: thankfully, most services out there offer public API to some extent
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000001">
<h3 id="org0000001"><a class="headerlink" href="#org0000001">¶</a>private API</h3>
<div class="outline-text-3" id="text-org0000001">
<p>
Sometimes service doesn't offer an API. 
But from the developer's perspective, it's still very reasonable to use one when you've got backend/frontend communication.
</p>
<p>
So chances are, the service just isn't exposing it, but you can spy on the token/cookies in your browser devtools and use them to access the API.
</p>
<p>
You can read more about handling such data sources here:
</p>
<ul class="org-ul">
<li><a href="https://willschenk.com/articles/2019/reverse_engineering_apis_using_chrome">Reverse engineering APIs using Chrome Developer Tools</a>: an extremely comprehensive and beginner-friendly tutorial</li>
<li><a href="https://blog.tendigi.com/starbucks-should-really-make-their-apis-public-6b64a1c2e923">Starbucks should really make their API public</a>: demo of reverse engineering Starbucks Android app, featuring using proxy and ??? fingerprint</li>
</ul>
<p>
Some examples:
</p>
<ul class="org-ul">
<li>for <a href="https://github.com/karlicoss/fbmessengerexport">exporting Messenger data</a>, I'm using <a href="https://fbchat.readthedocs.io/en/stable">fbchat</a> library. It works by tricking Facebook into believing it's a browser and interacting with private API.</li>
<li>even though Pocket has API, to get highlights from it, you need to <a href="https://github.com/karlicoss/pockexport#setting-up">spy on API key</a> they use in browser</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org000001c">
<h3 id="export_scrape"><a class="headerlink" href="#export_scrape">¶</a>scraping</h3>
<div class="outline-text-3" id="text-export_scrape">
<p>
Sometimes service doesn't offer an API, doesn't use it even internally and serves HTML pages directly instead.
Or, reverse engineering API is so painful that scraping becomes a more feasible option.
</p>
<p>
Apart from TODO link? difficulties, there are extras here:
</p>
<ul class="org-ul">
<li>authorization is harder: you definitely need username/password and potentially even 2FA token</li>
<li>DDOS protection: captchas, Cloudflare, etc.</li>
<li>or even deliberate anti-scraping measures</li>
</ul>
<p>
For Python the holy grail of scraping is <a href="https://scrapy.org">scrapy</a>:
</p>
<ul class="org-ul">
<li><a href="http://sangaline.com/post/advanced-web-scraping-tutorial">Advanced Web Scraping Tutorial</a>: bypassing "403 Forbidden", captchas, and more</li>
<li><a href="https://gist.github.com/alecxe/fc1527d6d9492b59c610">self-contained minimum example script to run scrapy</a></li>
</ul>
<p>
I'm pretty sure there are similar libraries for other languages, perhaps you could start with <a href="https://github.com/lorien/awesome-web-scraping">awesome-web-scraping repo</a> or <a href="https://news.ycombinator.com/item?id=15694118">Ask HN: What are best tools for web scraping?</a>.
</p>
<p>
For dealing with authorization, my personal experience is that using persistent <a href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.firefox.firefox_profile">profile directory</a> in Selenium is sufficient in most cases: you can login once manually and after that, reuse the profile in your scripts.
</p>
<p>
Examples:
</p>
<ul class="org-ul">
<li>even though Hackernews has <a href="https://github.com/HackerNews/API">API for public data</a>, there is no way of getting your upvotes/saves without scraping HTML.</li>
<li>Amazon or Paypal have to be <a href="https://github.com/jbms/finance-dl#supported-data-sources">scraped</a> if you want your data.</li>
<li>my bank, HSBC doesn't have an API. Not that I expected it from HSBC, I don't live in a fairy tail, but even their manual transactions exports are in PDF which I have to <a href="https://github.com/karlicoss/hsbc-parser">parse</a>.</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org000001d">
<h3 id="export_manual"><a class="headerlink" href="#export_manual">¶</a>manual export (GDPR/takeout)</h3>
<div class="outline-text-3" id="text-export_manual">
<p>
It's great they exist, and it is the easiest way to get your data if you just want a backup.
That doesn't really help in the log run though:
</p>
<ul class="org-ul">
<li>you can only do it now and then</li>
<li>it's manual: typically requires requesting and clicking on email link.</li>
</ul>
<ul class="org-ul">
<li>it's slow and asynchronous: normally takes few days</li>
<li>format differs from API format, often ends up as something neither machine friendly nor human friendly</li>
</ul>
<p>
That said, with certain effort it can potentially be automated too.
</p>
<p>
They can be useful to get 'initial' bit of your data, past the <a href="sad-infra.html#data_is_vanishing">API limits</a>.
</p>
<p>
Examples:
</p>
<ul class="org-ul">
<li><a href="https://takeout.google.com">Google Takeout</a></li>
<li><a href="https://help.twitter.com/en/managing-your-account/how-to-download-your-twitter-archive">Twitter Archive</a></li>
<li><a href="https://github.blog/2018-12-19-download-your-data">Github</a> data export</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org000001e">
<h3 id="export_phone"><a class="headerlink" href="#export_phone">¶</a>phone apps</h3>
<div class="outline-text-3" id="text-export_phone">
<p>
I don't have iPhone, so will only be referring to Android in this section, but I'd imagine the situation is similar.
</p>
<p>
These days, service might not even offer desktop version at all, and considering that scraping data off mobile apps is way harder, getting it from the phone directly might be an easier option. In addition, the data is often kept as an sqlite database, which is in many ways even better than using API!
</p>
<p>
On Android the story is simple: apps keep their data in <samp class="inline">/data/data/</samp> directory, which is not accessible unless you <b>root</b> your phone.
These days, with <a href="https://magiskmanager.com">magisk</a> it's considerably easier, however it's still definitely not something a typical Android user would be able to do. Also rooting your phone can bring all sorts of trouble by triggering root detection (e.g. common in banking apps), so be careful.
</p>
<p>
Once you have root, you can write a script to copy necessary files from <samp class="inline">/data/data/</samp> to your target directory, synchronized with your computer (e.g. via <a href="https://play.google.com/store/apps/details?id=com.ttxapps.dropsync&amp;hl=en_GB">dropbox</a> or <a href="https://play.google.com/store/apps/details?id=com.github.catfriend1.syncthingandroid&amp;hl=en_GB">syncthing</a>).
</p>
<p>
I'm using <a href="https://play.google.com/store/apps/details?id=com.llamalab.automate&amp;hl=en">Automate app</a> to run export scripts on the phone, but that feels like something that should be solved by a cron-like tool, so please let me know if you know one!
</p>
<p>
Examples:
</p>
<ul class="org-ul">
<li>you can export Whatsapp data by copying <samp class="inline">/data/data/com.whatsapp/databases/msgstore.db</samp></li>
<li><a href="https://github.com/karlicoss/promnesia/blob/master/scripts/backup-phone-history.sh">scripts</a> for exporting mobile Chrome/Firefox browsing history</li>
<li>exporting <a href="https://bluemaestro.com">Bluemaestro</a> environment sensor data</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org000001f">
<h3 id="export_devices"><a class="headerlink" href="#export_devices">¶</a><span class="todo TODO">TODO</span> devices?</h3>
<div class="outline-text-3" id="text-export_devices">
<p>
TODO better name?
</p>
<p>
Finally, the nastiest TODO???
</p>
<p>
Here I'm referring to standalone specific-purpose devices like sleep trackers, e-ink readers, etc, TODO ?? when device doesn't have Interenet access or doesn't talk to any API.
</p>
<p>
You've got several options here:
</p>
<ul class="org-ul">
<li><p>
device is capable of synchronizing with your phone (e.g. via Bluetooth)
</p>
<p>
It's probably easiest to rely on <a class="link-up" href="#export_phone">phone app exports</a> here.
If sync has to be triggered manually, you can use some <a href="https://play.google.com/store/apps/details?id=com.llamalab.automate&amp;hl=en">UI automation</a> to TODO burden of .
</p></li>
<li><p>
device is running Linux and has Internet access
</p>
<p>
You can potentially run export script on the device itself and send the data somewhere else.
Another option is running SSH server on the device and pulling data from it, but it's quite extreme.
</p></li>
<li><p>
device can mount to a computer
</p>
<p>
Then, you can use <a href="https://en.wikipedia.org/wiki/Udev">udev</a> to trigger export when device is plugged in.
If udev feels too complicated to you, even a cron script running every minute might be enough.
</p></li>
</ul>
<p>
Examples:
</p>
<ul class="org-ul">
<li>using <a href="https://github.com/karlicoss/kobuddy#as-a-backup-tool">kobuddy</a> for semiautomatic exports from Kobo e-ink reader</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000024">
<h2 id="types"><a class="headerlink" href="#types">¶</a><span class="section-number-2">3</span> Types of exports</h2>
<div class="outline-text-2" id="text-types">
<p>
Hopefully the previous section answers your questions on 'where do I get my data from'.
</p>
<p>
Now, let's establish a bit of vocabulary here.
Since data exports by their nature are somewhat similar to <a href="https://en.wikipedia.org/wiki/Backup#Backup_methods">backups</a>, I'm borrowing some terminology.
</p>
<p>
The way I see it, there are three styles of data exports:
</p>
</div>
<div class="outline-3" id="outline-container-org0000021">
<h3 id="full"><a class="headerlink" href="#full">¶</a>full export</h3>
<div class="outline-text-3" id="text-full">
<p>
Basically, every time you run export, go exhaustively through all the endpoints, and fetch the data.
As a result you get some sort of JSON file, which you can keep in a plaintext file.
</p>
<p>
With full export, typically it's okay to overwrite the older export once you fetched everything. 
However I wouldn't recommend it (TODO backups and also atomic stuff?)
</p>
<ul class="org-ul">
<li>advantages
<ul class="org-ul">
<li>straightforward to implement</li>
</ul></li>
<li>disadvantages
<ul class="org-ul">
<li><b>might be impossible</b> due to <a href="sad-infra.html#data_is_vanishing">API restrictions</a></li>
<li>takes more resources, i.e. time/bandwith/cpu/memory</li>
<li>takes more space if you're keeping old versions</li>
<li>might be flaky due to excessive network requests</li>
</ul></li>
</ul>
<p>
TODO when to use full export? not much data, e.g. TODO
TODO link to examples      
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000022">
<h3 id="incremental"><a class="headerlink" href="#incremental">¶</a>incremental export</h3>
<div class="outline-text-3" id="text-incremental">
<p>
'Incremental' means that rerunning export starts off latest persisted state and only fetches missing data.
</p>
<p>
Implementation-wise, that means that you need some extra logic to determine the point (e.g. timestamp/message id) to continue from, fetch missing data and persist it back on disk. 
</p>
<p>
That introduces significant opportunities for errors:
</p>
<ul class="org-ul">
<li>if you're not careful with pagination (TODO link) misinterpret documentation you might never request some data</li>
<li>If you're not careful with transactional logic (TODO link), you might leave your export in an inconsistent state.</li>
</ul>
<p>
Incremental exports are <b>always</b> harder to program. Indeed, full backup is just an edge case of incremental one.
</p>
<p>
So why would you bother with exporting data incrementally?
</p>
<ul class="org-ul">
<li><p>
too much data
</p>
<p>
This doesn't even mean too much in terms of bandwidth/storage, more of 'too many entities'.
</p>
<p>
E.g. imagine you want to export your Twitter timeline of 10000 tweets, that's about 1Mb of raw text data.
Even if you account for extra garbage and assume 10 Mb or even 100 Mb of data, it's basically nothing if you're running it once a day.
</p>
<p>
However, APIs usually impose pagination (e.g. 200 tweets per call), so to get these 10000 tweets you might have to do <code class="inline">10000 / 200 = 50</code> API calls. 
Suddenly the whole thing feels much less reliable, so you might want to make it incremental in order to minimize number of network calls.
</p>
<p>
Examples:
</p>
<ul class="org-ul">
<li>Telegram/Messenger/Whatsapp – basically IM always means you're dealing with lots of data (TODO link)</li>
<li>emfit sleep data (API is a bit flaky)</li>
</ul></li>
<li><p>
data is too slow to retrieve
</p>
<p>
For instance, <a class="link-up" href="#export_scrape">web scraping</a> is always somewhat slow; in addition you might have to rate limit yourself so you don't get banned by DDOS prevention.
</p>
<p>
Also web scraping is even flakier than using APIs, so you might want to avoid extra work if possible
</p></li>
</ul>
<p>
XXX TODO
</p>
<ul class="org-ul">
<li>advantages
<ul class="org-ul">
<li>takes less resources</li>
<li>more resilient (if done right) as needs less network operations</li>
</ul></li>
<li>disadvantages
<ul class="org-ul">
<li>potentially very error prone, harder to implement</li>
</ul></li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org0000023">
<h3 id="synthetic"><a class="headerlink" href="#synthetic">¶</a>synthetic export</h3>
<div class="outline-text-3" id="text-synthetic">
<div><span class="before-aside">
This is kind of a blend between full export and incremental export.   

</span><aside class="sidenote">if someone can think of a better term for describing this concept, please let me know!</aside></div>
<p>
It's similar to full export in the sense that there isn't that much data to retrieve and if you could, you would just fetch it in one go.
</p>
<p>
However the difference that makes it similar to incremental exports is that you don't have all data available at once, only latest chunk.
The fundamental issue with synthetic exports is that no single export file will give you all of the data.
</p>
<p>
There are various reasons for that:
</p>
<ul class="org-ul">
<li><p>
API restrictions
</p>
<p>
Example: <a href="https://github.com/karlicoss/rexport#limitations">Reddit</a> limits your API queries to 1000 entries.
</p></li>
<li><p>
Limited memory
</p>
<p>
Example: autonomous devices like HR monitors or temperature monitors are embedded systems with limited memory.
</p>
<p>
Typically, they use some kind of <a href="https://en.wikipedia.org/wiki/Circular_buffer">ring buffer</a> so when you export data, you only get, say, latest 10000 measurements.
</p></li>
<li><p>
Disagreement on the 'state' of the system
</p>
<p>
Example: Kobo reader uses <a href="https://github.com/karlicoss/kobuddy">sqlite database</a> for keeping metadata like highlights, which is awesome!
However, when you delete the book from your reader, it removes your annotations and highlights from the database too.
</p>
<p>
There is absolutely no reason to do this: I delete the book because I don't need it on my reader, not because I want to get rid of annotations.
So in order to have all of them my only option is having regular database snapshots and assembling the full database from these pieces.
</p></li>
<li><p>
Security
</p>
<p>
Example: <a href="https://docs.monzo.com/#list-transactions">Monzo bank API</a>. 
</p>
<blockquote>
<p>
After a user has authenticated, your client can fetch all of their transactions, and after 5 minutes, it can only sync the last 90 days of transactions. If you need the user’s entire transaction history, you should consider fetching and storing it right after authentication. 
</p>
</blockquote>
<p>
So that means that unless you're happy with manually authorizing every time you export, you will only have access to the last 90 days of transactions.
</p>
<p>
Note: I feel kind of sorry complaining at Monzo, considering they are the nicest guys out there in terms of being dev friendly.
But that's the only example of such behavior I've seen so far.
</p></li>
</ul>
<p>
One important difference from other types of exports is that you <b>have to</b> do them regularly/often enough.
Otherwise, you inevitably miss some data and in best case, have go through <a class="link-up" href="#export_manual">alternative ways</a> of retrieving it, or worst case, <a href="./takeout-data-gone.html">lose it forever</a>.
</p>
<p>
Now, you could deal with these same way you would with incremental exports, by pulling missing data only.
However, if you do make a mistake in your merging logic (TODO mention merging above), it's not just a matter of waiting to re-download everything. 
Some of the data might be gone <b>forever</b>.
</p>
<p>
So I take a hybrid approach instead:
</p>
<ul class="org-ul">
<li><p>
at export time, we retrieve all the data we can and keep it along with a timestamp, like full export.
</p>
<p>
Basically, it makes it 'append-only system', so there is no opportunity for losing data.
</p></li>
<li><p>
at <a class="link-down" href="#dal">data access time</a>, we dynamically synthesize full export
</p>
<p>
We go through through all chunks and reconstruct full state, similarly to incremental export.
That's where 'synthetic' comes from.
</p>
<p>
The full export only exists at runtime, and errors in merging logic are not problematic as you never overwrite data.
</p></li>
</ul>
<p>
Summary of the method:
</p>
<ul class="org-ul">
<li>advantages
<ul class="org-ul">
<li>much easier way to achieve incremental exports without having to worry about introducing inconsistencies</li>
<li>very resilient, against pretty much everything: deleted content, data corruption, flaky APIs, programming errors</li>
<li>straightforward to normalize and unify – you are not overwriting anything</li>
</ul></li>
<li>disadvantages
<ul class="org-ul">
<li><p>
takes extra space
</p>
<p>
That said, storage shouldn't be that much of a concert unless you export <b>very</b> often.
With time, storage available grows exponentially and get cheaper, whereas amount of data you generate grows linearly, hence running exports periodically would only take 'quadratic' space.
</p>
<p>
If this is an issue, it can also be addressed with compression or even using deduplicating backup software like <a href="https://borgbackup.readthedocs.io/en/stable">borg</a> for storage. However, that would come at the cost of slowing down access.
</p></li>
<li><p>
takes more time to merge snapshots and process
</p>
<p>
Again, it only results in linear slowdown with time and pretty instantaneous for most data sources I have.
</p>
<p>
That can be addressed with TODO using iterators? (so access time is amortized)
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000030">
<h2 id="export_layer"><a class="headerlink" href="#export_layer">¶</a><span class="section-number-2">4</span> Export layer</h2>
<div class="outline-text-2" id="text-export_layer">
<p>
No matter which way you have to use to export your data, there are some common difficulties, hence patterns which I'm going to explore in this section.
</p>
<p>
Do the <b>absolute minimum</b> work required to get raw data. This is kind of vague, so I will try to explain what I mean by that. TODO elaborate?
</p>
<p>
This section doesn't cover the TODO exact specifics, but it's more of collection of tips of minimizing work necessary:
</p>
</div>
<div class="outline-3" id="outline-container-org000002b">
<h3 id="bindings"><a class="headerlink" href="#bindings">¶</a>use existing bindings</h3>
<div class="outline-text-3" id="text-bindings">
<p>
This may be obvious, but I still feel it has to be said.
Unless retrieving data is trivial (i.e. single GET request), chances that someone already invested effort in dealing with various API quirks.
Bindings often deal with dirty details like API limiting, retrying, pagination etc., so if you're lucky you might end up spending very little effort on exporting data.
</p>
<p>
If there is something in bindings you don't like or lack, it's still easier to monkey patch (if you're using dynamic language) or just fork and patch them up (don't forget to open a pull request later!).
</p>
<p>
Also if you're the author of bindings, I have few requests. Please:
</p>
</div>
<div class="outline-4" id="outline-container-org0000025">
<h4 id="org0000025">Please never print in stdout. It's a pain to filter out and suppress</h4>
</div>
<div class="outline-4" id="outline-container-org0000026">
<h4 id="org0000026"><span class="todo TODO">TODO</span> Please add debug logging. It's pretty sad to</h4>
<div class="outline-text-4" id="text-org0000026">
<p>
TODO write about requests logging?
</p>
</div>
</div>
<div class="outline-4" id="outline-container-org0000027">
<h4 id="org0000027">Please don't be overly defensive, or allow for non-defensive behavior.</h4>
<div class="outline-text-4" id="text-org0000027">
<p>
It's quite sad when library silently catches all exception and replaces with empty strings/nulls/etc without you knowing it.
</p>
</div>
</div>
<div class="outline-4" id="outline-container-org0000028">
<h4 id="org0000028">Please expose raw underlying data (typically, json)</h4>
<div class="outline-text-4" id="text-org0000028">
<p>
If you forget to handle something or the user disagrees how to interpret data they can hack it with accessing raw underlying TODO chunk??
</p>
<p>
  Example of good data object:
<a href="https://github.com/pawelad/pymonzo/blob/b5c8d4f46dcb3a2f475797a8b8ef1c15f6493fb9/src/pymonzo/api_objects.py#L38">https://github.com/pawelad/pymonzo/blob/b5c8d4f46dcb3a2f475797a8b8ef1c15f6493fb9/src/pymonzo/api_objects.py#L38</a>
<a href="https://github.com/pawelad/pymonzo/blob/b5c8d4f46dcb3a2f475797a8b8ef1c15f6493fb9/src/pymonzo/monzo_api.py#L189">https://github.com/pawelad/pymonzo/blob/b5c8d4f46dcb3a2f475797a8b8ef1c15f6493fb9/src/pymonzo/monzo_api.py#L189</a>
</p>
</div>
</div>
<div class="outline-4" id="outline-container-org0000029">
<h4 id="org0000029">Please expose generic methods for handling API calls to make it easy to add new endpoints</h4>
</div>
<div class="outline-4" id="outline-container-org000002a">
<h4 id="org000002a"><span class="todo TODO">TODO</span> examples of employing these principles</h4>
<div class="outline-text-4" id="text-org000002a">
<p>
To export <a href="https://github.com/karlicoss/hypexport">Hypothes.is</a> data I'm using existing <a href="https://github.com/judell/Hypothesis">python bindings</a>.
</p>
<ul class="org-ul">
<li>bindings handle <a href="https://github.com/judell/Hypothesis/blob/91f881693546aaddc4096327a97f5cf342c3770a/hypothesis.py#L69">pagination and rate limits</a> for you</li>
<li>even though bindings expose <a href="https://github.com/judell/Hypothesis/blob/master/hypothesis.py#L191"><code class="inline">HypothesisAnnotation</code></a> helper, but default they return raw json, making it trivial to serialize data TODO rephrase/reorder?</li>
<li>bindings expose generic <a href="https://github.com/judell/Hypothesis/blob/91f881693546aaddc4096327a97f5cf342c3770a/hypothesis.py#L138"><code class="inline">authenticated_api_query</code></a> method
For instance, profile data request was missing from the bindings; and it was <a href="https://github.com/karlicoss/hypexport/blob/7a80b36aa55da8b541e2778141eb84ada384d734/hypexport.py#L14">trivial</a> to get it anyway</li>
</ul>
<p>
Thanks to good bindings, the actual export is pretty much <a href="https://github.com/karlicoss/hypexport/blob/7a80b36aa55da8b541e2778141eb84ada384d734/hypexport.py#L6-L19">trivial</a>.
</p>
<p>
Another example: to export <a href="https://github.com/karlicoss/rexport/blob/master/rexport.py">Reddit data</a>, I'm using <a href="https://github.com/praw-dev/praw">praw</a>, excellent library for accessing Reddit from Python.
</p>
<ul class="org-ul">
<li>praw handles rate limits and pagination</li>
<li>praw supports all endpoints, so exporting data is just a matter of <a href="https://github.com/karlicoss/rexport/blob/d001e2d07d716130106ebe07a021f98d84a5ed93/rexport.py#L73-L84">calling right API methods</a></li>
<li>one shortcoming of praw though is that it wouldn't give you access to raw JSON data for some reason, so we need some <a href="https://github.com/karlicoss/rexport/blob/d001e2d07d716130106ebe07a021f98d84a5ed93/rexport.py#L32-L55">hacky logic</a> to serialize.</li>
</ul>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org0000002">
<h3 id="org0000002"><a class="headerlink" href="#org0000002">¶</a>do not mess with raw data</h3>
<div class="outline-text-3" id="text-org0000002">
<p>
Keep the data you retrieved as intact as possible.
</p>
<p>
E.g. an api serves XML and you don't like working with it. Fair enough. But don't try to convert it to JSON prior to saving on disk.
</p>
<ul class="org-ul">
<li>if you do that, you will need to: deserialize XML (during export) -&gt; serialize to JSON (to save on disk) -&gt; deserialize JSON (to access data)</li>
<li>if you keep intact XML on disk, you'll just need to: deserialize XML (to access data)</li>
</ul>
<p>
Both approaches need working with XML at some point inevitably.
However the latter one is less error prone due to less chance of misinterpreting data and missing fields.
</p>
<p>
Instead, keep exporter code simple and don't try to interpret data in it.
Move data interpretation burden to runtime and data access layer instead. TODO
</p>
<p>
There are exceptions to this rule, e.g. when you need to use a database and have to impose a schema.
Even in that case it might be a good idea to be extra safe and keep data as strings where feasible and assert/warn on schema changes to be extra safe.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000003">
<h3 id="org0000003"><a class="headerlink" href="#org0000003">¶</a>do not be too defensive</h3>
<div class="outline-text-3" id="text-org0000003">
<p>
<b>Never</b> fallback on some wort of default values TODO
TODO generic requests module hook?? dunno.
TODO not sure how to communicate this point, I mean it's kinda of nice if one is willing to do this. But it's hard too
</p>
<p>
If you're willing to – go for it, but TODO it's hard
</p>
<p>
In my experience, it's fair to assume that if export fails, it's a random server side glitch and not worth fine tuning, it's easier to start export all over again.
</p>
<p>
TODO I'm handling this in a generic way with wrapper script TODO explained later
</p>
<p>
I'd only recommend doing it if you know for sure that certain error 
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org000002d">
<h3 id="output_stdout"><a class="headerlink" href="#output_stdout">¶</a>output to stdout</h3>
<div class="outline-text-3" id="text-output_stdout">
<p>
That's not always an option, e.g. if export is incremental and the underlying storage is sqlite.
However when feasible (e.g. json/csv), outputting to stdout makes your export composable with other tools and makes error handling easier.
</p>
<p>
TODO be atomic TODO applicable to incremental export
be familiar with the underlying storage you're using and its guarantees
</p>
<p>
TODO compression
TODO naming files
</p>
<p>
TODO elaborate more?
</p>
<p>
One particular example is atomic file writing.
Imagine you've started your export, opened a file and your program crashed in the middle of writing.
Typically that would mean a corrupted export file, that would cause issues downstream.
</p>
<p>
On many files systems moving files is atomic, which can be used to implement atomic writes. However it's somewhat <a href="https://stackoverflow.com/a/2333979/706389">boilerplaty</a>.
If you want to be portable (e.g. <a href="https://stackoverflow.com/a/167555/706389">support Windows</a>), it's going to be even harder to get right.
You really don't want to remember to copy paste it or reimplement every time.
</p>
</div>
<div class="outline-4" id="outline-container-org000002c">
<h4 id="org000002c"><span class="todo TODO">TODO</span> not sure how to integrate timestamps here? maybe separate export wrapper in a separate file?</h4>
</div>
</div>
<div class="outline-3" id="outline-container-org0000004">
<h3 id="org0000004"><a class="headerlink" href="#org0000004">¶</a><span class="timestamp-wrapper"><span class="timestamp">[2019-12-26 23:22]</span></span> allow reading credentials from a file</h3>
<div class="outline-text-3" id="text-org0000004">
<p>
TODO link to export<sub>helper</sub> here
</p>
<ul class="org-ul">
<li>you don't want them in your shell history or in crontabs</li>
<li><p>
Keeping them in file can potentially allow for finer control access
</p>
<p>
E.g. with Unix permissions you could only allow certain scripts to read secrets.
</p></li>
</ul>
<p>
Note that I'm not a security expert, so would be interested to know if there are better solutions to that
</p>
</div>
<div class="outline-4" id="outline-container-org000002e">
<h4 id="org000002e"><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-26 23:23]</span></span> even better, python script, e.g. potentially it makes it easier to put auth code close etc</h4>
<div class="outline-text-4" id="text-org000002e">
<p>
TODO also link to post that python is a good format for configs?
</p>
</div>
</div>
<div class="outline-4" id="outline-container-org000002f">
<h4 id="org000002f"><span class="todo TODO">TODO</span> <span class="priority">[C]</span> benefits of having secrets in python file: you can keep auth code close to the secrets   <span class="tag"><span class="blog">blog</span> <span class="python">python</span></span></h4>
<div class="outline-text-4" id="text-org000002f">
<p>
e.g. getting new secrets – rerun the secrets.py file
can leave comments (e.g. unlike json)
</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000005">
<h2 id="org0000005"><a class="headerlink" href="#org0000005">¶</a><span class="section-number-2">5</span> Data organization: how to keep it</h2>
<div class="outline-text-2" id="text-5">
<p>
TODO not sure if I like the name?  
</p>
<p>
As I mentioned (TODO link), for the most parts I'm just keeping raw data from APIs.
For storage I'm just using filesystem; all exports are kept or symlinked in the same directory (<code class="inline">/exports</code>) for ease of access:
</p>
<div class="org-src-container">
<pre class="src src-bash">find /exports/ | sort | head -n 20 | tail -n 7
</pre>
</div>
<pre class="example">
/exports/feedbin
/exports/feedly
/exports/firefox-history
/exports/fitbit
/exports/github
/exports/github-events
/exports/goodreads
</pre>
</div>
<div class="outline-3" id="outline-container-org0000031">
<h3 id="timestamps"><a class="headerlink" href="#timestamps">¶</a>naming and timestamping</h3>
<div class="outline-text-3" id="text-timestamps">
<p>
The only important bit is making sure that if you keep multiple exports (TODO i.e. synthetic), their names include timestamps, and time order is consistent with lexicographic order.
</p>
<p>
That means that that the only acceptable date/time format is some variation of <a href="https://en.wikipedia.org/wiki/ISO_8601"><code class="inline">YYYY MM DD HH MM SS Z</code></a>. 
Feel free to sprinkle it with any separators you like, or use milliseconds if you are really serious, but any other date format, e.g. <samp class="inline">MM/DD/YY</samp>, using month names, or not using zero-padded numbers is going to bring you serious grief.
</p>
<p>
E.g.:
</p>
<div class="org-src-container">
<pre class="src src-bash">ls /exports/instapaper/ | tail -n 5
</pre>
</div>
<pre class="example">
instapaper_20200101T000005Z.json
instapaper_20200101T040004Z.json
instapaper_20200101T080010Z.json
instapaper_20200101T120005Z.json
instapaper_20200101T160011Z.json
</pre>
<p>
Reason is it's automatically sort/max friendly, which massively reduces cognitive load when working with data.
</p>
<p>
To make timestamping automatic and less boilerplaty, I'm using a wrapper script. TODO link
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000032">
<h3 id="backups"><a class="headerlink" href="#backups">¶</a>backups</h3>
<div class="outline-text-3" id="text-backups">
<p>
Backups are trivial: I can just run <a href="https://borgbackup.readthedocs.io/en/stable">borg</a> against <samp class="inline">/exports</samp>.
What is more, borg is deduplicating, so it's quite friendly to synthetic exports.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000033">
<h3 id="sync"><a class="headerlink" href="#sync">¶</a>synchronizing</h3>
<div class="outline-text-3" id="text-sync">
<p>
I synchronize/replicate it across my computers with Syncthing, also used Dropbox in the past.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000006">
<h3 id="org0000006"><a class="headerlink" href="#org0000006">¶</a>disk space concerns</h3>
<div class="outline-text-3" id="text-org0000006">
<p>
 TODO move stuff from synthetic exports here and interlink
 TODO better heading?
As I mentioned, storage grows exponentially, whereas your exports grow linearly or quadratically depending on how to think about it.
</p>
<p>
For most of my exports, I don't even bother compressing, for the few that I do need to compress, TODO wrapper can handle it.
Remember that if you compress, you will typically be paying for it with ease and performance of data access.
</p>
<p>
There are potential ways of TODO
</p>
<ul class="org-ul">
<li><p>
keeping data under borg and using <a href="https://borgbackup.readthedocs.io/en/stable/usage/mount.html">borg mount</a> to access it.
</p>
<p>
You get deduplication for free, however this makes exporting and accessing data way more obscure, and in addition borg mount locks the repository so it's going to be read only while you access it.
</p></li>
<li><p>
using filesystem capable of compressing on the fly
</p>
<p>
E.g. <a href="https://serverfault.com/questions/740456/lightweight-transparent-compression-filesystem">ZFS/BTRFS</a>.
</p>
<p>
It seems straightforward enough, however be careful as it <a href="https://www.linuxuprising.com/2018/11/how-to-use-dropbox-on-non-ext4.html">might impact cloud sync</a>.
I haven't personally tried it.
</p></li>
</ul>
</div>
<div class="outline-4" id="outline-container-org0000034">
<h4 id="org0000034"><span class="todo STRT">STRT</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-26 23:57]</span></span> compression – bwrapper</h4>
<div class="outline-text-4" id="text-org0000034">
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000035">
<h2 id="arctee"><a class="headerlink" href="#arctee">¶</a><span class="section-number-2">6</span> arctee</h2>
<div class="outline-text-2" id="text-arctee">
<p>
TODO eh. still would be nice to have a better name…  
</p>
<p>
This is a <a href="https://github.com/karlicoss/exportwrapper">script</a> I'm using to run most of data exports.
</p>
<p>
Many things are very common to all data exports, regardless the source.
In vast majority of cases you want to fetch some data, save it in a json file long with a timestamp and potentially compress.
</p>
<p>
This script aims to minimize common boilerplate:
</p>
<ul class="org-ul">
<li><samp class="inline">path</samp> argument allows easy ISO8601 timestamping and guarantees atomic writing, so you'd never end up with corrupted exports.</li>
<li><samp class="inline">--compression</samp> allows to compress simply by passing format. No more <samp class="inline">tar -zcvf</samp>!</li>
<li><samp class="inline">--retries</samp> allows easy exponential backoff in case service you're querying is flaky.</li>
</ul>
<p>
Example:
</p>
<pre class="example">
arctee '/exports/rtm/{utcnow}.ical.xz' --compression xz --retries 3 -- /soft/export/rememberthemilk.py
</pre>
<ol class="org-ol">
<li><p>
runs <samp class="inline">/soft/export/rememberthemilk.py</samp>, retrying it up to three times if it fails
</p>
<p>
The script is expected to dump its result in stdout; stderr is simply passed through.
</p></li>
<li>once the data is fetched it's compressed as <samp class="inline">xz</samp></li>
<li>timestamp is computed and compressed data is written to <samp class="inline">/exports/rtm/20200102T170015Z.ical.xz</samp></li>
</ol>
<p>
I'm elaborating a bit more on motivation for a helper script <a href="https://github.com/karlicoss/exportwrapper#do-you-really-need-a-special-script-for-that">here</a>.
</p>
<p>
Hopefully that explains some things I mentioned above:
</p>
<ul class="org-ul">
<li>dumping to stdout (TODO link): makes it easier to retry, be atomic and compress</li>
<li>not doing fine grained backoff: I find that in almost all cases global backoff via <samp class="inline">--retries</samp> is sufficient TODO link</li>
</ul>
<p>
In addition, wrapper script is programming language agnostic, as long as you export script simply outputs to stdout, it doesn't matter how it's implemented.
</p>
<p>
That said, it feels kind of wrong to have an extra script for all these things since they are not hard in principle, just tedious and boring to do all over again. If anyone has bright ideas on simplifying parts of this, I'd be happy to know!
</p>
</div>
<div class="outline-3" id="outline-container-org0000007">
<h3 id="org0000007"><a class="headerlink" href="#org0000007">¶</a><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-28 23:56]</span></span> I guess in 'DAL' mention that bwrapper is useful here too.</h3>
</div>
</div>
<div class="outline-2" id="outline-container-org0000008">
<h2 id="org0000008"><a class="headerlink" href="#org0000008">¶</a><span class="section-number-2">7</span> <span class="todo TODO">TODO</span> Running/scheduling exports etc?</h2>
<div class="outline-text-2" id="text-7">
<p>
TODO Infrastructure? 
TODO for incremental synthetic exports, empathize that it will be clear how to use that later (and link straight to DAL section dealing with it)
</p>
<p>
Being able to run data export is one thing. 
</p>
<p>
But then, ideally you want to keep them running and more or less forget about it, only checking them now and then.
</p>
<p>
You want 
</p>
<p>
I'm using fcron to run my jobs TODO <a href="https://wiki.archlinux.org/index.php/cron#Fcron">https://wiki.archlinux.org/index.php/cron#Fcron</a>
</p>
<p>
TODO make sure to mention how to configure local mail on errors?
TODO yeah, kron isn't worth mentioning here…
</p>
</div>
<div class="outline-3" id="outline-container-org0000009">
<h3 id="org0000009"><a class="headerlink" href="#org0000009">¶</a><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-30 00:59]</span></span> going to overlap with data organization bit?</h3>
</div>
<div class="outline-3" id="outline-container-org000000a">
<h3 id="org000000a"><a class="headerlink" href="#org000000a">¶</a><span class="todo TODO">TODO</span> suggest using fcron?   <span class="tag"><span class="exports">exports</span></span></h3>
<div class="outline-text-3" id="text-org000000a">
</div>
</div>
<div class="outline-3" id="outline-container-org000000b">
<h3 id="org000000b"><a class="headerlink" href="#org000000b">¶</a><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 22:26]</span></span> I feel a real lack of user-friendly job running software</h3>
<div class="outline-text-3" id="text-org000000b">
<p>
Ideally I want something
</p>
<ul class="org-ul">
<li><p>
as easy to configure as regular cron
</p>
<p>
Being able to edit single configuration file and quickly add/remove jobs and change schedule (<samp class="inline">crontab -e</samp>)
</p></li>
<li><p>
keeping configuration under version control
</p>
<p>
Possible with cron, but requires some extra tools and getting used to it.
</p></li>
<li>better means of monitoring TOOD dashboard?
How often are my jobs running? How much resources are they using?</li>
<li>better specs for jobs
Can I introduce dependencies, timeouts, resource restrictions or retries without tons of custom scripts and boilerplate in crontabs?</li>
<li><p>
better means of notification
I'm kind of fine with using mutt for viewing local email.
TODO maybe switch to emacs?
</p>
<p>
Perhaps I should switch to thunderbird? Not sure what is used real world TODO?
</p></li>
</ul>
<p>
Systemd – too verbose (e.g. you need to install service/restart etc)
</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000036">
<h2 id="dal"><a class="headerlink" href="#dal">¶</a><span class="section-number-2">8</span> Data access layer (DAL)</h2>
<div class="outline-text-2" id="text-dal">
</div>
<div class="outline-3" id="outline-container-org000000c">
<h3 id="org000000c"><a class="headerlink" href="#org000000c">¶</a><span class="todo TODO">TODO</span> normalization? E.g. new field was added, basically schema change. That means old data needs to be adapted</h3>
<div class="outline-text-3" id="text-org000000c">
<p>
Example: your banking app used to only support single account, so it was kind of reasonable to keep data as a `List[Transaction]`.
</p>
<p>
Now that they added support for multiple accounts, you have to represent data as `Dict[Account, List[Transaction]]`.
</p>
<p>
Than would mean adapting old data to the new format, e.g. you could extract account id from one of transactions and use it a dictionary key.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org000000d">
<h3 id="org000000d"><a class="headerlink" href="#org000000d">¶</a><span class="todo TODO">TODO</span> <span class="priority">[C]</span> would be nice to have main for models?   <span class="tag"><span class="dataliberation">dataliberation</span></span></h3>
<div class="outline-text-3" id="text-org000000d">
</div>
</div>
<div class="outline-3" id="outline-container-org000000e">
<h3 id="org000000e"><a class="headerlink" href="#org000000e">¶</a><span class="todo TODO">TODO</span> <span class="priority">[C]</span> do simple html dashboards for each exporter?   <span class="tag"><span class="dataliberation">dataliberation</span></span></h3>
<div class="outline-text-3" id="text-org000000e">
</div>
</div>
<div class="outline-3" id="outline-container-org000000f">
<h3 id="org000000f"><a class="headerlink" href="#org000000f">¶</a><span class="todo TODO">TODO</span> <span class="priority">[C]</span> take single path as argument? or maybe glob=true?   <span class="tag"><span class="dataliberation">dataliberation</span></span></h3>
<div class="outline-text-3" id="text-org000000f">
</div>
</div>
<div class="outline-3" id="outline-container-org0000010">
<h3 id="org0000010"><a class="headerlink" href="#org0000010">¶</a><span class="todo TODO">TODO</span> it's also an experiment in organizing code. demo etc, immediately visualize stuff with pandas   <span class="tag"><span class="exports">exports</span> <span class="blog">blog</span> <span class="dal">dal</span></span></h3>
<div class="outline-text-3" id="text-org0000010">
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000011">
<h2 id="org0000011"><a class="headerlink" href="#org0000011">¶</a><span class="section-number-2">9</span> Similar projects and efforts</h2>
<div class="outline-text-2" id="text-9">
</div>
<div class="outline-3" id="outline-container-org0000012">
<h3 id="org0000012"><a class="headerlink" href="#org0000012">¶</a>perkeep</h3>
<div class="outline-text-3" id="text-org0000012">
<p>
Seems to be object-centric, so I'd imagine I would need to communicate with perkeep server to get my stuff?
<a href="https://perkeep.org/doc/compare#objects-not-files">https://perkeep.org/doc/compare#objects-not-files</a>
</p>
<p>
I didn't manage to find a way to query <a href="https://perkeep.org/cmd/">https://perkeep.org/cmd/</a>
I'm not sure if the idea is there needs to be intermediate middleware with a finer API.
<a href="https://perkeep.org/doc/protocol/">https://perkeep.org/doc/protocol/</a>
</p>
<p>
Apparently it enforces schema? <a href="https://deeunderscore.github.io/blog/keeping-things-in-perkeep.html">https://deeunderscore.github.io/blog/keeping-things-in-perkeep.html</a>
</p>
<p>
<a href="https://perkeep.org/doc/overview">https://perkeep.org/doc/overview</a>
</p>
<p>
<a href="https://perkeep.org/doc/uses">https://perkeep.org/doc/uses</a>
</p>
<p>
Ok, it's a bit unclear what it can be used for?
</p>
<p>
<a href="https://news.ycombinator.com/item?id=17615696">https://news.ycombinator.com/item?id=17615696</a>
</p>
</div>
<div class="outline-4" id="outline-container-org0000040">
<h4 id="org0000040">trying out</h4>
<div class="outline-text-4" id="text-org0000040">
</div>
<ul class="org-ul">
<li><a id="org0000037"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:00]</span></span> pinboard importer failed (json parsing)<br /></li>
<li><a id="org0000038"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:01]</span></span> instapaper – couldn't authorize?<br /></li>
<li><a id="org0000039"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:11]</span></span> twitter – some crap about 'switching to developer account'<br /></li>
<li><a id="org000003a"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:11]</span></span> mastodon – success<br /></li>
<li><a id="org000003b"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:12]</span></span> couldn't search for text in UI<br />
<div class="outline-text-5" id="text-org000003b">
<p>
Invalid SearchQuery: Error parsing search expression "whatever": No support for literals yet at position 0, token: "whatever" See: <a href="https://perkeep.org/doc/search-ui">https://perkeep.org/doc/search-ui</a>
</p>
</div>
</li>
<li><a id="org000003c"></a>couldn't see imported data in the fuse mount<br />
<div class="outline-text-5" id="text-org000003c">
<p>
<a href="https://perkeep.org/cmd/pk-mount">https://perkeep.org/cmd/pk-mount</a>, couldn't figure out what's root-blobref
</p>
</div>
</li>
<li><a id="org000003d"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:33]</span></span> couldn't figure out how to request stuff from my importer either via API or HTTP<br /></li>
<li><a id="org000003e"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:33]</span></span> happy if someone using Perkeep points me at the right direction!<br /></li>
<li><a id="org000003f"></a><span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:55]</span></span> apparently not very TODO developed? <a href="https://github.com/perkeep/perkeep/releases">https://github.com/perkeep/perkeep/releases</a><br /></li>
</ul>
</div>
<div class="outline-4" id="outline-container-org0000041">
<h4 id="org0000041"><span class="todo TODO">TODO</span> <span class="timestamp-wrapper"><span class="timestamp">[2020-01-01 13:29]</span></span> could extract in a separate file perhaps?</h4>
</div>
</div>
<div class="outline-3" id="outline-container-org0000013">
<h3 id="org0000013"><a class="headerlink" href="#org0000013">¶</a><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2018-09-18 02:13]</span></span> <a href="https://reddit.com/r/selfhosted/comments/9go5if/perkeep_lets_you_permanently_keep_your_stuff_for/e665vi6/">Perkeep lets you permanently keep your stuff, for life.</a> /r/selfhosted   <span class="tag"><span class="pkm">pkm</span></span></h3>
<div class="outline-text-3" id="text-org0000013">
<p>
The landing page is too light on details, imho. I get that there's a 'docs' section but at least put something on the opening page more concrete than "if you're technical, you can probably get it up and running" that lets me know what the software actually does.
</p>
<p>
Also, how is this better or worse than any of the other options that are currently available?
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000014">
<h3 id="org0000014"><a class="headerlink" href="#org0000014">¶</a><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-23 16:21]</span></span> Perkeep: personal storage system for life | Hacker News   <span class="tag"><span class="graspw">graspw</span> <span class="pkm">pkm</span></span></h3>
<div class="outline-text-3" id="text-org0000014">
<p>
<a href="https://news.ycombinator.com/item?id=18008240">https://news.ycombinator.com/item?id=18008240</a>
Selection:
</p>
<p>
setra on Sept 17, 2018 [-]
</p>
<p>
TDLR: This is a content addressed data store similar to IPFS (although this project is older). You can configure one of several backends such as local file storage, S3, SSH, etc. It includes an organization system based on tags, and other meta data. You can construct a fuse filesystem representation based on a query. A web UI exists allowing exploration of existing files, uploading, etc.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000015">
<h3 id="org0000015"><a class="headerlink" href="#org0000015">¶</a><span class="todo TODO">TODO</span> <span class="priority">[C]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-22 16:19]</span></span> perkeep   <span class="tag"><span class="gr">gr</span></span></h3>
<div class="outline-text-3" id="text-org0000015">
<p>
<a href="https://news.ycombinator.com/item?id=21844105">https://news.ycombinator.com/item?id=21844105</a>
Selection:
gpchelkin 4 hours ago [-]
</p>
<p>
I think that Perkeep <a href="https://perkeep.org">https://perkeep.org</a> is also worth mentioning here. One of their latest tools is the one for exporting Google Photos: <a href="https://github.com/perkeep/gphotos-cdp">https://github.com/perkeep/gphotos-cdp</a>
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000016">
<h3 id="org0000016"><a class="headerlink" href="#org0000016">¶</a><span class="todo TODO">TODO</span> <span class="priority">[A]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-15 21:31]</span></span> Digital Tools I Wish Existed | Hacker News   <span class="tag"><span class="perkeep">perkeep</span></span></h3>
<div class="outline-text-3" id="text-org0000016">
<p>
<a href="https://news.ycombinator.com/item?id=21659876">https://news.ycombinator.com/item?id=21659876</a>
Selection:
Perkeep fits some of these cases
</p>
<p>
UnmitigatedFart 12 days ago [-]
</p>
<p>
Huh. This is fascinating project, this does tick some of the boxes for me. Thanks.
</p>
</div>
</div>
<div class="outline-3" id="outline-container-org0000017">
<h3 id="org0000017"><a class="headerlink" href="#org0000017">¶</a><span class="todo TODO">TODO</span> <span class="priority">[B]</span> <span class="timestamp-wrapper"><span class="timestamp">[2019-12-23 16:19]</span></span> Perkeep – Open-source data modeling, storing, search, sharing and synchronizing | Hacker News   <span class="tag"><span class="graspw">graspw</span> <span class="pkm">pkm</span></span></h3>
<div class="outline-text-3" id="text-org0000017">
<p>
<a href="https://news.ycombinator.com/item?id=15928685">https://news.ycombinator.com/item?id=15928685</a>
Selection:
</p>
<p>
mastax on Dec 15, 2017 [-]
</p>
<p>
Since people are confused about what this is I'll write a summary (from old memory so it's probably 80% correct)
It is a consumer-oriented storage system that is:
</p>
<ul class="org-ul">
<li>Content addressable</li>
<li>Indexed</li>
<li>Tag-oriented (vs. hierarchical)</li>
<li>Permissions, encryption, compression, sharing, etc.</li>
<li>Spans storage across machines and clouds</li>
<li>FUSE mountable</li>
<li>Has CLI and Web interfaces built-in</li>
</ul>
<p>
The intent is to be a personal data dumpster that you can throw all of your files and other data (tweets, etc.) into for search and backup.
</p>
<p>
The website could be better organized to convey this information quickly.
</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0000018">
<h2 id="org0000018"><a class="headerlink" href="#org0000018">¶</a><span class="section-number-2">10</span> --</h2>
<div class="outline-text-2" id="text-10">
<p>
TODO Approaches I describe works well for me so far. It feels like it's fairly composable, allows for injection TODO and TODO
</p>
<p>
However, it still feels like something that shouldn't have been so hard in the first place and ??? to be solved in a more generic way.
</p>
</div>
</div>
<div class="outline-2" id="outline-container-org0000019">
<h2 id="org0000019"><a class="headerlink" href="#org0000019">¶</a><span class="section-number-2">11</span> <span class="todo TODO">TODO</span> example of not keeping raw data: praw   <span class="tag"><span class="exports">exports</span> <span class="blog">blog</span> <span class="reddit">reddit</span></span></h2>
<div class="outline-text-2" id="text-11">
<p>
sadly praw doesn't keep raw json data :( <a href="https://github.com/praw-dev/praw/issues/830">https://github.com/praw-dev/praw/issues/830</a>
</p>
</div>
</div>
<div class="outline-2" id="outline-container-org000001a">
<h2 id="org000001a"><a class="headerlink" href="#org000001a">¶</a><span class="section-number-2">12</span> <span class="todo TODO">TODO</span> arctee motivation of treating all errors as api flickering/network   <span class="tag"><span class="blog">blog</span> <span class="exports">exports</span></span></h2>
<div class="outline-text-2" id="text-12">
<p>
'better ask for forgiveness than permission' is a questionable practice in many cases, but it feels like the right one</p>
</div>
</div>

    </section>

    
    <section class="footer">
        <div class="post-tags"><a class="post-tag" href="./tags.html#infra">#infra</a> <a class="post-tag" href="./tags.html#dataliberation">#dataliberation</a> <a class="post-tag" href="./tags.html#pkm">#pkm</a></div>
        <!-- TODO post-date? -->
        <div class="date">01 January 2020</div>
    </section>
    

    

    <section class="comments">
    <script data-isso="https://beepb00p.xyz/comments/" data-isso-reply-to-self="true" src="https://beepb00p.xyz/comments/js/embed.min.js">
</script>

<section id="isso-thread" data-isso-id="isso_exports"></section>

    </section>

</article>

        </main>

        <!-- TODO hmm maybe display something in a footer, so it's clear it's end of content... -->
        
        <footer>
            <span style="float:left">
            <a href="https://twitter.com/karlicoss">🐦 me @twitter</a>
            ·
            <a href="https://github.com/karlicoss">💻 me @github</a>
            </span>

            <a href="http://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>
            
            
        </footer>
    </body>
</html>
